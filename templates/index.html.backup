<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilibiliè§†é¢‘çƒ­åº¦ç›‘è§†å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ä¸»é¢˜å˜é‡ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #000000;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e0e0e0;
            --accent-color: #000000;
            --card-bg: #ffffff;
            --hover-bg: #f0f0f0;
            --success-color: #2d2d2d;
            --error-color: #000000;
            --chart-grid: #e0e0e0;
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-hover: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-tertiary: #808080;
            --border-color: #404040;
            --accent-color: #ffffff;
            --card-bg: #2d2d2d;
            --hover-bg: #404040;
            --success-color: #d4d4d4;
            --error-color: #ffffff;
            --chart-grid: #404040;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-hover: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 30px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header-left h1 { 
            color: var(--text-primary); 
            margin-bottom: 8px; 
            font-size: 28px; 
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        .subtitle { 
            color: var(--text-secondary); 
            font-size: 14px; 
            font-weight: 400;
        }
        .theme-toggle {
            width: 48px;
            height: 48px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        .theme-toggle:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        .tab:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }
        .tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .control-group { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        label { 
            color: var(--text-secondary); 
            font-size: 13px; 
            font-weight: 500;
        }
        input, select, button, textarea {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        textarea { 
            resize: vertical; 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            line-height: 1.6;
        }
        button {
            background: var(--accent-color);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        button:hover { 
            opacity: 0.85;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        button:active {
            transform: translateY(0);
        }
        .refresh-btn { 
            background: var(--text-primary);
            color: var(--bg-primary);
        }
        .settings-btn { 
            background: var(--text-secondary);
            color: var(--bg-primary);
        }
        .danger-btn { 
            background: var(--text-primary);
            color: var(--bg-primary);
            border: 1px solid var(--border-color);
        }
        .chart-container {
            position: relative;
            height: 450px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .video-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .video-chip {
            padding: 10px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }
            text-align: center;
        }
        .video-chip:hover {
            border-color: #00a1d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,161,214,0.2);
        }
        .video-chip.selected {
            background: #00a1d6;
            color: white;
            border-color: #00a1d6;
            box-shadow: 0 4px 12px rgba(0,161,214,0.3);
        }
        .video-chip-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .video-chip-bv {
            font-size: 11px;
            opacity: 0.7;
        }
        .video-chip.selected .video-chip-bv {
            opacity: 0.9;
        }
        .settings-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .settings-group { margin-bottom: 25px; }
        .settings-group h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .delete-section {
            background: #fff2f0;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ffccc7;
            margin-top: 20px;
        }
        .delete-section h3 {
            color: #ff4d4f;
            margin-bottom: 15px;
        }
        .loading { text-align: center; color: #666; padding: 40px; }
        .error {
            background: #fff2f0;
            color: #ff4d4f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffccc7;
        }
        .success {
            background: #f6ffed;
            color: #52c41a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #b7eb8f;
        }
        .last-update {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading::before {
            content: "âŸ³";
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            font-size: 20px;
        }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-card h4 {
            color: #00a1d6;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { color: #666; font-size: 12px; }
        .stat-value { color: #333; font-weight: bold; font-size: 14px; }
        .video-list-select {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .video-list-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .video-title-main {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .video-bv-sub {
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Bilibiliè§†é¢‘çƒ­åº¦ç›‘è§†å™¨</h1>
        <p class="subtitle">å®æ—¶è¿½è¸ªå¤šè§†é¢‘æ•°æ®å˜åŒ–è¶‹åŠ¿</p>

        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('monitor')">ğŸ“ˆ æ•°æ®ç›‘æ§</button>
            <button class="tab" onclick="switchTab('compare')">ğŸ“Š å¤šè§†é¢‘å¯¹æ¯”</button>
            <button class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
        </div>

        <!-- æ•°æ®ç›‘æ§æ ‡ç­¾é¡µ -->
        <div id="tab-monitor" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label for="videoSelect">é€‰æ‹©è§†é¢‘:</label>
                    <select id="videoSelect" class="video-list-select" onchange="loadSelectedVideo()">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="dataLimit">æ˜¾ç¤ºæ•°æ®ç‚¹:</label>
                    <select id="dataLimit" onchange="loadSelectedVideo()">
                        <option value="20">æœ€è¿‘20æ¡</option>
                        <option value="50" selected>æœ€è¿‘50æ¡</option>
                        <option value="100">æœ€è¿‘100æ¡</option>
                        <option value="200">æœ€è¿‘200æ¡</option>
                    </select>
                    <button class="refresh-btn" onclick="loadSelectedVideo()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="singleChart"></canvas>
            </div>
        </div>

        <!-- å¤šè§†é¢‘å¯¹æ¯”æ ‡ç­¾é¡µ -->
        <div id="tab-compare" class="tab-content">
            <div class="video-selector" id="videoSelector">
                <div class="loading">åŠ è½½è§†é¢‘åˆ—è¡¨ä¸­...</div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="compareLimit">æ˜¾ç¤ºæ•°æ®ç‚¹:</label>
                    <select id="compareLimit" onchange="loadCompareData()">
                        <option value="20">æœ€è¿‘20æ¡</option>
                        <option value="50" selected>æœ€è¿‘50æ¡</option>
                        <option value="100">æœ€è¿‘100æ¡</option>
                    </select>
                    <label for="compareMetric">å¯¹æ¯”æŒ‡æ ‡:</label>
                    <select id="compareMetric" onchange="loadCompareData()">
                        <option value="view">æ’­æ”¾é‡</option>
                        <option value="like">ç‚¹èµæ•°</option>
                        <option value="coin">æŠ•å¸æ•°</option>
                        <option value="favorite">æ”¶è—æ•°</option>
                        <option value="share">è½¬å‘æ•°</option>
                        <option value="online">åœ¨çº¿äººæ•°</option>
                    </select>
                    <button class="refresh-btn" onclick="loadCompareData()">åˆ·æ–°å¯¹æ¯”</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="compareChart"></canvas>
            </div>

            <div class="stats-summary" id="statsSummary"></div>
        </div>

        <!-- ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µ -->
        <div id="tab-settings" class="tab-content">
            <div class="settings-panel">
                <div class="settings-group">
                    <h3>â° æŠ“å–é—´éš”è®¾ç½®</h3>
                    <div class="control-group">
                        <label for="fetchInterval">æŠ“å–é—´éš”ï¼ˆåˆ†é’Ÿï¼‰:</label>
                        <input type="number" id="fetchInterval" min="1" max="1440" value="10" style="width: 100px;" />
                        <span style="color: #999; font-size: 12px;">å»ºè®®ï¼š5-30åˆ†é’Ÿ</span>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>ğŸ“ ç›‘æ§è§†é¢‘åˆ—è¡¨</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                        æ¯è¡Œè¾“å…¥ä¸€ä¸ªBVå·ï¼Œå°†è‡ªåŠ¨ä¿å­˜åˆ° monitor.list æ–‡ä»¶
                    </p>
                    <textarea id="monitorList" rows="10" style="width: 100%; max-width: 600px;" 
                              placeholder="BV1xx411c7XZ&#10;BV2yy222d8YY&#10;BV3zz333e9ZZ"></textarea>
                </div>

                <div class="control-group">
                    <button class="settings-btn" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                    <button onclick="loadSettings()">ğŸ”„ é‡æ–°åŠ è½½</button>
                </div>
            </div>

            <!-- æ•°æ®æ¸…ç†éƒ¨åˆ† -->
            <div class="delete-section">
                <h3>ğŸ—‘ï¸ æ•°æ®æ¸…ç†</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    æ¸…ç†æŒ‡å®šè§†é¢‘æˆ–æ—¶é—´æ®µçš„å†å²æ•°æ®ï¼ˆæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼‰
                </p>

                <div class="settings-group">
                    <label for="deleteVideo">é€‰æ‹©è§†é¢‘ï¼ˆç•™ç©ºè¡¨ç¤ºæ‰€æœ‰è§†é¢‘ï¼‰:</label>
                    <select id="deleteVideo" style="width: 100%; max-width: 400px;">
                        <option value="">æ‰€æœ‰è§†é¢‘</option>
                    </select>
                </div>

                <div class="settings-group">
                    <h4 style="font-size: 14px; color: #666; margin-bottom: 10px;">æ—¶é—´èŒƒå›´ï¼ˆç•™ç©ºè¡¨ç¤ºä¸é™ï¼‰:</h4>
                    <div class="control-group">
                        <label for="deleteStartDate">å¼€å§‹æ—¥æœŸ:</label>
                        <input type="date" id="deleteStartDate" />
                        <label for="deleteEndDate">ç»“æŸæ—¥æœŸ:</label>
                        <input type="date" id="deleteEndDate" />
                    </div>
                </div>

                <div class="control-group">
                    <button class="danger-btn" onclick="confirmDeleteData()">ğŸ—‘ï¸ æ¸…ç†æ•°æ®</button>
                    <span style="color: #999; font-size: 12px;">åˆ é™¤å‰ä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†</span>
                </div>
            </div>

            <div style="margin-top: 30px; padding: 15px; background: #fff7e6; border-radius: 8px; border: 1px solid #ffd591;">
                <h4 style="color: #fa8c16; margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                <ul style="color: #666; font-size: 13px; line-height: 1.8; margin-left: 20px;">
                    <li>ä¿®æ”¹ç›‘æ§è®¾ç½®åï¼Œéœ€è¦é‡å¯ monitor.py ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆ</li>
                    <li>å»ºè®®æŠ“å–é—´éš”è®¾ç½®ä¸º 5-30 åˆ†é’Ÿï¼Œé¿å…é¢‘ç¹è¯·æ±‚</li>
                    <li>æ•°æ®æ¸…ç†åŠŸèƒ½å¯ä»¥é‡Šæ”¾æ•°æ®åº“ç©ºé—´ï¼Œä½†æ— æ³•æ¢å¤</li>
                    <li>å¯ä»¥æŒ‰è§†é¢‘æˆ–æ—¶é—´èŒƒå›´çµæ´»æ¸…ç†æ•°æ®</li>
                </ul>
            </div>
        </div>

        <div class="last-update" id="lastUpdate"></div>
    </div>

    <script>
        let singleChart = null, compareChart = null, currentBvId = '';
        let selectedVideos = new Set(), allVideos = [], allVideosInfo = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (tabName === 'compare') loadVideoList();
            else if (tabName === 'settings') loadSettings();
            else if (tabName === 'monitor') loadVideoListForMonitor();
        }

        async function init() {
            try {
                await loadVideoListForMonitor();
            } catch (error) {
                showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½è§†é¢‘åˆ—è¡¨ï¼ˆç”¨äºæ•°æ®ç›‘æ§é¡µï¼‰
        async function loadVideoListForMonitor() {
            try {
                const res = await fetch('/api/videos/info');
                const result = await res.json();
                
                if (result.code === 0 && result.data.length > 0) {
                    allVideosInfo = result.data;
                    const select = document.getElementById('videoSelect');
                    select.innerHTML = '';
                    
                    result.data.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.bv_id;
                        option.textContent = `${video.title} (${video.bv_id})`;
                        select.appendChild(option);
                    });
                    
                    currentBvId = result.data[0].bv_id;
                    await loadSelectedVideo();
                } else {
                    document.getElementById('videoSelect').innerHTML = '<option value="">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œç›‘æ§ç¨‹åº</option>';
                }
            } catch (error) {
                showError('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½é€‰ä¸­çš„è§†é¢‘
        async function loadSelectedVideo() {
            const select = document.getElementById('videoSelect');
            currentBvId = select.value;
            
            if (!currentBvId) {
                showError('è¯·é€‰æ‹©è§†é¢‘');
                return;
            }

            hideMessages();
            
            try {
                const limit = document.getElementById('dataLimit').value;
                const response = await fetch(`/api/video/${currentBvId}/stats?limit=${limit}`);
                const result = await response.json();

                if (result.code === 0 && result.data.length > 0) {
                    renderSingleChart(result.data);
                    updateLastUpdateTime();
                } else {
                    showError('æš‚æ— æ•°æ®');
                }
            } catch (error) {
                showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“å•è§†é¢‘å›¾è¡¨ï¼ˆæ”¹ä¸ºé¢ç§¯å›¾ï¼‰
        function renderSingleChart(data) {
            const ctx = document.getElementById('singleChart').getContext('2d');
            
            const labels = data.map(item => {
                const date = new Date(item.timestamp);
                return date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            });

            const datasets = [
                {
                    label: 'æ’­æ”¾é‡',
                    data: data.map(i => i.view),
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    fill: true,
                    yAxisID: 'y',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'ç‚¹èµ',
                    data: data.map(i => i.like),
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.2)',
                    fill: true,
                    yAxisID: 'y1',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'æŠ•å¸',
                    data: data.map(i => i.coin),
                    borderColor: '#ffe66d',
                    backgroundColor: 'rgba(255, 230, 109, 0.2)',
                    fill: true,
                    yAxisID: 'y1',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'æ”¶è—',
                    data: data.map(i => i.favorite),
                    borderColor: '#a8e6cf',
                    backgroundColor: 'rgba(168, 230, 207, 0.2)',
                    fill: true,
                    yAxisID: 'y1',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'è½¬å‘',
                    data: data.map(i => i.share),
                    borderColor: '#dcedc1',
                    backgroundColor: 'rgba(220, 237, 193, 0.2)',
                    fill: true,
                    yAxisID: 'y1',
                    tension: 0.4,
                    borderWidth: 2
                }
            ];

            if (singleChart) singleChart.destroy();
            
            singleChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `${data[data.length-1]?.title || currentBvId}`, font: { size: 16 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'æ’­æ”¾é‡' },
                            ticks: {
                                callback: function(value) {
                                    return value >= 10000 ? (value/10000).toFixed(1) + 'ä¸‡' : value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'å…¶ä»–æŒ‡æ ‡' },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                callback: function(value) {
                                    return value >= 10000 ? (value/10000).toFixed(1) + 'ä¸‡' : value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // åŠ è½½è§†é¢‘åˆ—è¡¨ï¼ˆç”¨äºå¯¹æ¯”é¡µï¼‰
        async function loadVideoList() {
            try {
                const res = await fetch('/api/videos/info');
                const result = await res.json();
                
                if (result.code === 0) {
                    allVideosInfo = result.data;
                    renderVideoSelector();
                }
            } catch (error) {
                showError('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è§†é¢‘é€‰æ‹©å™¨ï¼ˆä¼˜åŒ–æ˜¾ç¤ºï¼‰
        function renderVideoSelector() {
            const container = document.getElementById('videoSelector');
            
            if (allVideosInfo.length === 0) {
                container.innerHTML = '<div style="color: #999;">æš‚æ— ç›‘æ§è§†é¢‘ï¼Œè¯·å…ˆè¿è¡Œç›‘æ§ç¨‹åº</div>';
                return;
            }

            container.innerHTML = '';
            
            allVideosInfo.forEach(video => {
                const chip = document.createElement('div');
                chip.className = 'video-chip';
                if (selectedVideos.has(video.bv_id)) {
                    chip.classList.add('selected');
                }
                chip.innerHTML = `
                    <div class="video-chip-title">${video.title}</div>
                    <div class="video-chip-bv">${video.bv_id}</div>
                `;
                chip.onclick = () => toggleVideoSelection(video.bv_id);
                container.appendChild(chip);
            });
        }

        function toggleVideoSelection(bv) {
            if (selectedVideos.has(bv)) selectedVideos.delete(bv);
            else selectedVideos.add(bv);
            renderVideoSelector();
            // åªæœ‰åœ¨æœ‰é€‰ä¸­è§†é¢‘æ—¶æ‰åŠ è½½æ•°æ®
            if (selectedVideos.size > 0) {
                loadCompareData();
            } else {
                // æ¸…ç©ºå›¾è¡¨
                if (compareChart) compareChart.destroy();
                document.getElementById('statsSummary').innerHTML = '';
            }
        }

        async function loadCompareData() {
            if (selectedVideos.size === 0) {
                // æ²¡æœ‰é€‰ä¸­è§†é¢‘æ—¶ï¼Œæ¸…ç©ºæ˜¾ç¤º
                if (compareChart) compareChart.destroy();
                document.getElementById('statsSummary').innerHTML = '';
                return;
            }
            hideMessages();
            try {
                const limit = document.getElementById('compareLimit').value;
                const metric = document.getElementById('compareMetric').value;
                const bvIds = Array.from(selectedVideos).join(',');
                const res = await fetch(`/api/videos/compare?bv_ids=${bvIds}&limit=${limit}`);
                const result = await res.json();
                if (result.code === 0) {
                    renderCompareChart(result.data, metric);
                    renderStatsSummary(result.data);
                    updateLastUpdateTime();
                } else {
                    showError('åŠ è½½å¯¹æ¯”æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                showError('åŠ è½½å¯¹æ¯”æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“å¯¹æ¯”å›¾è¡¨ï¼ˆæ”¹ä¸ºæŸ±çŠ¶+æŠ˜çº¿æ··åˆå›¾ï¼‰
        function renderCompareChart(data, metric) {
            const ctx = document.getElementById('compareChart').getContext('2d');
            const metricNames = { view: 'æ’­æ”¾é‡', like: 'ç‚¹èµæ•°', coin: 'æŠ•å¸æ•°', favorite: 'æ”¶è—æ•°', share: 'è½¬å‘æ•°', online: 'åœ¨çº¿äººæ•°' };
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#a8e6cf', '#dcedc1', '#ffd3b6', '#ffaaa5', '#b4a7d6'];
            const datasets = [];
            let colorIndex = 0;

            for (const [bv, stats] of Object.entries(data)) {
                if (stats.length > 0) {
                    datasets.push({
                        label: stats[0].title || bv,
                        data: stats.map(item => item[metric]),
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: `${colors[colorIndex % colors.length]}40`,
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                    colorIndex++;
                }
            }

            const firstBv = Object.keys(data)[0];
            const labels = data[firstBv] ? data[firstBv].map(item => {
                const date = new Date(item.timestamp);
                return date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }) : [];

            if (compareChart) compareChart.destroy();
            
            compareChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        title: { 
                            display: true, 
                            text: `å¤šè§†é¢‘${metricNames[metric]}å¯¹æ¯”`,
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: metricNames[metric] },
                            ticks: {
                                callback: function(value) {
                                    return value >= 10000 ? (value/10000).toFixed(1) + 'ä¸‡' : value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderStatsSummary(data) {
            const container = document.getElementById('statsSummary');
            container.innerHTML = '';
            for (const [bv, stats] of Object.entries(data)) {
                if (stats.length === 0) continue;
                const latest = stats[stats.length - 1];
                const first = stats[0];
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h4>${latest.title || bv}</h4>
                    <div class="stat-item"><span class="stat-label">BVå·</span><span class="stat-value">${bv}</span></div>
                    <div class="stat-item"><span class="stat-label">æ’­æ”¾é‡</span><span class="stat-value">${formatNumber(latest.view)} ${getChangeText(first.view, latest.view)}</span></div>
                    <div class="stat-item"><span class="stat-label">ç‚¹èµ</span><span class="stat-value">${formatNumber(latest.like)} ${getChangeText(first.like, latest.like)}</span></div>
                    <div class="stat-item"><span class="stat-label">æŠ•å¸</span><span class="stat-value">${formatNumber(latest.coin)} ${getChangeText(first.coin, latest.coin)}</span></div>
                    <div class="stat-item"><span class="stat-label">æ”¶è—</span><span class="stat-value">${formatNumber(latest.favorite)} ${getChangeText(first.favorite, latest.favorite)}</span></div>
                `;
                container.appendChild(card);
            }
        }

        function getChangeText(oldVal, newVal) {
            const change = newVal - oldVal;
            if (change > 0) return `<span style="color: #52c41a; font-size: 11px;">(+${formatFullNumber(change)})</span>`;
            else if (change < 0) return `<span style="color: #f5222d; font-size: 11px;">(${formatFullNumber(change)})</span>`;
            return '';
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/config');
                const result = await res.json();
                if (result.code === 0) {
                    document.getElementById('fetchInterval').value = result.data.fetch_interval_minutes || 10;
                    document.getElementById('monitorList').value = (result.data.monitor_list || []).join('\n');
                }

                // åŠ è½½è§†é¢‘åˆ—è¡¨åˆ°åˆ é™¤ä¸‹æ‹‰æ¡†
                const videoRes = await fetch('/api/videos/info');
                const videoResult = await videoRes.json();
                if (videoResult.code === 0) {
                    const select = document.getElementById('deleteVideo');
                    select.innerHTML = '<option value="">æ‰€æœ‰è§†é¢‘</option>';
                    videoResult.data.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.bv_id;
                        option.textContent = `${video.title} (${video.bv_id})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showError('åŠ è½½è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        async function saveSettings() {
            hideMessages();
            try {
                const interval = parseInt(document.getElementById('fetchInterval').value);
                const listText = document.getElementById('monitorList').value;
                const monitorList = listText.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
                if (interval < 1) { showError('æŠ“å–é—´éš”å¿…é¡»å¤§äº0'); return; }
                if (monitorList.length === 0) { showError('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè§†é¢‘BVå·'); return; }
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fetch_interval_minutes: interval, monitor_list: monitorList })
                });
                const result = await res.json();
                if (result.code === 0) {
                    showSuccess('è®¾ç½®ä¿å­˜æˆåŠŸï¼è¯·é‡å¯ monitor.py ç¨‹åºä½¿é…ç½®ç”Ÿæ•ˆ');
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        async function confirmDeleteData() {
            const bvId = document.getElementById('deleteVideo').value;
            const startDate = document.getElementById('deleteStartDate').value;
            const endDate = document.getElementById('deleteEndDate').value;

            let confirmMsg = 'ç¡®å®šè¦åˆ é™¤';
            if (bvId) {
                const videoInfo = allVideosInfo.find(v => v.bv_id === bvId);
                confirmMsg += ` è§†é¢‘ "${videoInfo ? videoInfo.title : bvId}"`;
            } else {
                confirmMsg += ' æ‰€æœ‰è§†é¢‘';
            }
            
            if (startDate || endDate) {
                confirmMsg += ' åœ¨';
                if (startDate) confirmMsg += ` ${startDate} è‡³`;
                if (endDate) confirmMsg += ` ${endDate}`;
                confirmMsg += ' æ—¶é—´æ®µ';
            }
            confirmMsg += ' çš„æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼';

            if (!confirm(confirmMsg)) return;

            hideMessages();
            try {
                const res = await fetch('/api/data/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bv_id: bvId || undefined, start_date: startDate || undefined, end_date: endDate || undefined })
                });
                const result = await res.json();
                if (result.code === 0) {
                    showSuccess(result.message);
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('deleteVideo').value = '';
                    document.getElementById('deleteStartDate').value = '';
                    document.getElementById('deleteEndDate').value = '';
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        function formatNumber(num) {
            if (num >= 10000) return (num / 10000).toFixed(2) + 'ä¸‡';
            return num.toLocaleString();
        }
        function formatFullNumber(num) {
            return num.toLocaleString();
        }
        function showError(msg) {
            const div = document.getElementById('errorMessage');
            div.textContent = 'âŒ ' + msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }
        function showSuccess(msg) {
            const div = document.getElementById('successMessage');
            div.textContent = 'âœ… ' + msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
        }
        window.onload = init;
    </script>
</body>
</html>
